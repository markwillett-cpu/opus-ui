<!DOCTYPE html>
<html lang="en">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Opus – Class Detail</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#2c3e50;--secondary:#34495e;--accent:#3498db;
      --success:#27ae60;--warning:#f39c12;--danger:#e74c3c;
      --light:#ecf0f1;--border:#bdc3c7;
      --power:#e74c3c;--core:#3498db;--library:#27ae60;--rest:#95a5a6;
    }
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f6fa;color:var(--primary);line-height:1.4}
    .opus-header{background:var(--secondary);color:#fff;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .opus-title{display:flex;align-items:center;gap:10px;font-weight:800;font-size:16px}
    .hamburger{font-size:22px;opacity:.9}
    .opus-nav{display:flex;gap:14px}
    .nav-item{color:#bdc3c7;text-decoration:none;font-size:13px;font-weight:700;padding:8px 10px;border-radius:4px;transition:.2s}
    .nav-item:hover{color:#fff;background:rgba(255,255,255,.08)}
    .nav-item.active{color:#fff;background:var(--accent)}
    .opus-toolbar{background:#3d4f5e;padding:10px 24px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #2c3e50}
    .toolbar-btn{background:#4a6278;color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;font-size:13px;font-weight:800;transition:.2s}
    .toolbar-btn.primary{background:var(--accent)}
    .container{max-width:1800px;margin:0 auto;padding:18px}
    .main-layout{display:grid;grid-template-columns:320px 1fr;gap:18px;height:calc(100vh - 160px)}
    .panel{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel-header{background:var(--secondary);color:#fff;padding:14px 16px;font-weight:900;font-size:14px}
    .panel-subheader{padding:12px 14px;border-bottom:1px solid var(--light)}
    .search-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px}
    .style-list{overflow:auto;padding:10px}
    .style-item{background:var(--light);padding:12px;border-radius:6px;cursor:pointer;margin-bottom:8px;border-left:3px solid transparent;transition:.2s}
    .style-item:hover{background:#e8f4f8;border-left-color:var(--accent)}
    .style-item.active{background:#e8f4f8;border-left-color:var(--accent);box-shadow:0 2px 4px rgba(0,0,0,.08)}
    .style-name{font-weight:900;font-size:14px;margin-bottom:4px}
    .style-meta{display:flex;justify-content:space-between;font-size:12px;color:#7f8c8d}
    .badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:900}
    .b-ok{background:#d4edda;color:#155724}
    .b-warn{background:#fff3cd;color:#856404}
    .b-bad{background:#f8d7da;color:#721c24}
    .category-header{background:var(--light);padding:18px 22px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:14px;align-items:flex-start}
    .category-header h2{font-size:18px;margin-bottom:4px}
    .subtext{color:#7f8c8d;font-size:13px}
    .content{padding:18px 22px;overflow:auto;flex:1;min-height:0}
    .info{background:#e8f4f8;border-left:4px solid var(--accent);padding:12px 14px;border-radius:4px;color:var(--primary);font-size:13px;margin-bottom:14px}
    .footer{border-top:1px solid var(--border);background:var(--light);padding:14px 22px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .footer-note{color:#7f8c8d;font-size:12px;font-weight:800}
    @media (max-width:1100px){.main-layout{grid-template-columns:1fr;height:auto}}

    .back-link{display:inline-flex;align-items:center;gap:4px;background:none;border:none;color:var(--accent);font-size:13px;font-weight:900;cursor:pointer;padding:0;margin-bottom:2px}
    .back-link:hover{text-decoration:underline}
    .detail-body{display:grid;grid-template-columns:1fr 260px;gap:18px;height:100%}
    .track-panel{display:flex;flex-direction:column;min-height:0;border:1px solid var(--light);border-radius:8px;overflow:hidden}
    .sel-bar{background:var(--secondary);color:#fff;padding:10px 12px;display:none;align-items:center;gap:10px;font-size:13px;font-weight:800}
    .sel-bar.visible{display:flex}
    .sel-bar .sel-n{font-size:16px;font-weight:1000}
    .sel-bar .sel-clear{margin-left:auto;background:none;border:none;color:#bdc3c7;font-size:12px;font-weight:900;cursor:pointer}
    .sel-bar .sel-clear:hover{color:#fff}
    .track-toolbar{background:var(--light);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .track-toolbar input{flex:1;min-width:180px;padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:13px}
    .track-toolbar select{padding:6px 10px;border:1px solid var(--border);border-radius:4px;background:#fff;font-size:12px}
    .track-scroll{overflow:auto;flex:1;min-height:0}
    .track-table{width:100%;min-width:1100px;border-collapse:collapse;font-size:13px}
    .track-table thead{background:var(--secondary);color:#fff;position:sticky;top:0;z-index:1}
    .track-table th,.track-table td{padding:10px 12px;font-size:13px;text-align:left;border-bottom:1px solid var(--light);white-space:nowrap}
    .track-table td.num{text-align:right;font-variant-numeric:tabular-nums}
    .track-table tbody tr:hover{background:#f8f9fa;cursor:pointer}
    .track-table tbody tr.checked{background:#eef6fc}
    .track-table .art{width:36px;height:36px;border-radius:3px;object-fit:cover}
    .sidebar{display:flex;flex-direction:column;gap:12px;overflow:auto}
    .card{background:var(--light);border-radius:6px;padding:14px}
    .card h3{font-size:11px;font-weight:900;text-transform:uppercase;letter-spacing:.4px;color:#7f8c8d;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
    .assign-btn{display:flex;align-items:center;gap:10px;width:100%;padding:12px 12px;border-radius:6px;border:2px solid transparent;background:#fff;cursor:pointer;font-size:14px;font-weight:900;color:var(--primary);transition:.15s;text-align:left}
    .assign-btn .ab-dot{width:14px;height:14px;border-radius:3px;flex-shrink:0;box-shadow:0 1px 2px rgba(0,0,0,.15)}
    .assign-btn .ab-label{flex:1}
    .assign-btn .ab-count{font-size:12px;font-weight:900;opacity:.45;font-variant-numeric:tabular-nums}
    .assign-btn.cls-primary{color:var(--power)}
    .assign-btn.cls-secondary{color:var(--core)}
    .assign-btn.cls-tertiary{color:var(--library)}
    .assign-btn.cls-rest{color:var(--rest)}
    .assign-btn.cls-uncat{color:#7f8c8d}
    .assign-btn:hover{border-color:currentColor}
    .assign-btn:disabled{opacity:.3;cursor:not-allowed;border-color:transparent !important}
    .assign-hint{font-size:12px;color:#7f8c8d;font-weight:800;margin-top:10px;text-align:center}
    .loading{text-align:center;padding:40px;color:#7f8c8d}
    .error{background:#f8d7da;border-left:4px solid var(--danger);padding:12px 14px;border-radius:4px;color:#721c24;font-size:13px;margin:14px}
    .success-toast{position:fixed;top:20px;right:20px;background:var(--success);color:#fff;padding:12px 18px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:1000;animation:slideIn .3s}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .class-dot{display:inline-block;width:16px;height:16px;border-radius:4px;margin-right:8px;vertical-align:middle}
    /* Force stats banner layout (override any collisions) */
.stats-banner{
  background:#2f3d4a;
  color:#fff;
  padding:14px 22px;
  display:grid !important;
  grid-template-columns:repeat(4,1fr) !important;
  gap:14px !important;
}
.stat-box{text-align:center}
.stat-label{font-size:11px;letter-spacing:.4px;opacity:.85;text-transform:uppercase}
.stat-value{font-size:22px;font-weight:1000;margin-top:4px}
.stat-sub{font-size:12px;opacity:.8;margin-top:2px}




  </style>
</head>
<body>
<div class="opus-header">
  <div class="opus-title"><span class="hamburger">☰</span> Custom Channels Opus</div>
  <nav class="opus-nav">
    <a class="nav-item" href="#">Tracks</a>
    <a class="nav-item active" href="#">Playback Classes</a>
    <a class="nav-item" href="#">Logs</a>
    <a class="nav-item" href="#">Reports</a>
  </nav>
</div>

<div class="opus-toolbar">
  <div class="toolbar-sep"></div>
  <button class="toolbar-btn primary" id="backToManagerBtn" type="button">
    Manage Playback Classes
  </button>
</div>


<div class="container">
  <div class="main-layout">

    <div class="panel">
      <div class="panel-header">Styles (Playlists)</div>
      <div class="panel-subheader"><input class="search-input" id="styleSearch" placeholder="Search styles..." /></div>
      <div class="style-list" id="styleList">
        <div class="loading">Loading styles...</div>
      </div>
    </div>

    <div class="panel">
      <div class="category-header">
        <div>
          <button class="back-link" onclick="history.back()">← Back</button>
          <h2>
            <span class="class-dot" id="classDot" style="background:var(--power)"></span>
            <span id="classTitle">A</span>
          </h2>
          <p class="subtext"><span id="styleName">Select a style</span> · <span id="classDescription">High-priority tracks</span></p>
        </div>
      </div>

      <div class="stats-banner">
        <div class="stat-box">
          <div class="stat-label" id="statLabel">In A</div>
          <div class="stat-value" id="statInClass">—</div>
          <div class="stat-sub" id="statPct">—</div>
        </div>
        <div class="stat-box"><div class="stat-label">Total Tracks</div><div class="stat-value" id="statTotal">—</div></div>
        <div class="stat-box"><div class="stat-label">Unassigned</div><div class="stat-value" id="statUnassigned">—</div></div>
        <div class="stat-box"><div class="stat-label">Selected</div><div class="stat-value" id="statSelected">0</div></div>
      </div>

      <div class="content">
        <div class="info">
          Select tracks and use the right sidebar to move them to another class or back to Uncategorized.
        </div>

        <div class="detail-body">
          <div class="track-panel">
            <div class="sel-bar" id="selBar">
              <span class="sel-n" id="selN">0</span>
              <span class="sel-lbl">selected</span>
              <button class="sel-clear" id="selClear">Clear selection</button>
            </div>

            <div class="track-toolbar">
              <input type="text" id="trackSearch" placeholder="Search tracks..." />
              <select id="sortBy">
                <option value="title">Sort by Title</option>
                <option value="artist">Sort by Artist</option>
                <option value="album">Sort by Album</option>
              </select>
            </div>

            <div class="track-scroll">
              <table class="track-table">
<thead>
  <tr>
    <th style="width:40px"><input type="checkbox" id="selectAll" /></th>
    <th style="width:50px"></th>
    <th>Title</th>
    <th>Artist</th>
    <th>Album</th>
    <th>Library Styles</th>
    <th style="width:80px">Year</th>
    <th style="width:80px">Time</th>
  </tr>
</thead>

                <tbody id="trackBody">
                  <tr><td colspan="7" class="loading">Select a style...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="sidebar">
            


            <div class="card">
              <h3>Move to Class</h3>
              <button class="assign-btn cls-primary" data-class="A"><div class="ab-dot" style="background:var(--power)"></div><div class="ab-label">A</div><div class="ab-count">0</div></button>
              <button class="assign-btn cls-secondary" data-class="B"><div class="ab-dot" style="background:var(--core)"></div><div class="ab-label">B</div><div class="ab-count">0</div></button>
              <button class="assign-btn cls-tertiary" data-class="C"><div class="ab-dot" style="background:var(--library)"></div><div class="ab-label">C</div><div class="ab-count">0</div></button>
              <button class="assign-btn cls-rest" data-class="Rest"><div class="ab-dot" style="background:var(--rest)"></div><div class="ab-label">Rest</div><div class="ab-count">0</div></button>
              <button class="assign-btn cls-uncat" data-class="Uncategorized"><div class="ab-dot" style="background:#95a5a6"></div><div class="ab-label">Uncategorized</div><div class="ab-count">0</div></button>
              <div class="assign-hint" id="assignHint">Select tracks to move</div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="footer-note">Changes save to Supabase</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // =========================
  // SUPABASE CONFIG
  // =========================
  const SUPABASE_URL = 'https://quuxtalnpdcommlylwlp.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_Lvv-SG7eonq1OO3T5Y7ofg__aF4eDRQ';
  window.db = window.db || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // =========================
  // URL PARAMS
  // =========================
  const urlParams = new URLSearchParams(window.location.search);
  const currentClassCode = urlParams.get('class') || 'A';
  const initialStyleId = urlParams.get('style_id') || null;

  // =========================
  // DB COMPAT HELPERS
  // =========================
  async function fetchStyleSongRows(styleId) {
  const { data, error } = await window.db
    .from('sim_style_songs')
    .select('library_song_id, sim_duration_seconds, library_songs(id, artist, title, album, peak_year, run_time_seconds, styles)')
    .eq('style_id', styleId);

  if (error) throw error;

  return (data || []).map(r => {
  const s = r.library_songs || {};
  return {
    song_id: r.library_song_id,
    song: {
      id: s.id,
      artist: s.artist,
      title: s.title,
      album: s.album,
      year: s.peak_year ?? '',
      // prefer sim_duration_seconds, otherwise library run_time_seconds
      duration: (r.sim_duration_seconds ?? s.run_time_seconds ?? 0),
      styles: s.styles || ''
    }
  };
});

}

async function fetchAssignments(styleId) {
  const { data, error } = await window.db
    .from('sim_style_song_classes')
    .select('library_song_id, class_code')
    .eq('style_id', styleId);

  if (error) throw error;

  const m = {};
  (data || []).forEach(r => {
    if (r.library_song_id) m[r.library_song_id] = r.class_code;
  });
  return m;
}

 async function upsertAssignments(rows) {
  const payload = rows.map(r => ({
    style_id: r.style_id,
    class_code: r.class_code,
    library_song_id: r.song_id
  }));

  return await window.db
    .from('sim_style_song_classes')
    .upsert(payload, { onConflict: 'library_song_id,style_id' });
}


 async function deleteAssignments(styleId, songIds) {
  return await window.db
    .from('sim_style_song_classes')
    .delete()
    .eq('style_id', styleId)
    .in('library_song_id', songIds);
}




  // =========================
  // CLASS MIX WEIGHTS (sim_style_class_weights)
  // =========================
  const DEFAULT_WEIGHTS = { A: 30, B: 40, C: 30, REST: 0 };
  let currentWeights = { ...DEFAULT_WEIGHTS };
  let mixSaveT = null;

  async function fetchWeights(styleId) {
    const { data, error } = await window.db
      .from('sim_style_class_weights')
      .select('class_code, weight_pct')
      .eq('style_id', styleId);

    if (error) throw error;

    const out = { ...DEFAULT_WEIGHTS };
    (data || []).forEach(r => {
      const code = (r.class_code || '').toUpperCase();
      if (out[code] !== undefined) out[code] = Number(r.weight_pct) || 0;
    });
    return normalizeWeights(out);
  }

  async function upsertWeights(styleId, weights) {
    const payload = ['A','B','C','REST'].map(code => ({
      style_id: styleId,
      class_code: code,
      weight_pct: weights[code] ?? 0
    }));

    return await window.db
      .from('sim_style_class_weights')
      .upsert(payload, { onConflict: 'style_id,class_code' });
  }

  function clamp(n, lo, hi){ return Math.max(lo, Math.min(hi, n)); }

  function normalizeWeights(w) {
    const codes = ['A','B','C','REST'];
    const raw = codes.map(c => clamp(Math.round(Number(w[c]||0)), 0, 100));
    let sum = raw.reduce((a,b)=>a+b,0);

    if (sum === 100) return { A: raw[0], B: raw[1], C: raw[2], REST: raw[3] };
    if (sum === 0) return { ...DEFAULT_WEIGHTS };

    const scaled = raw.map(v => (v / sum) * 100);
    const ints = scaled.map(v => Math.floor(v));
    let remain = 100 - ints.reduce((a,b)=>a+b,0);

    const fracs = scaled.map((v,i)=>({i, frac: v - Math.floor(v)})).sort((a,b)=>b.frac-a.frac);
    for (let k=0; k<remain; k++) ints[fracs[k % fracs.length].i] += 1;

    return { A: ints[0], B: ints[1], C: ints[2], REST: ints[3] };
  }

  function renderMix() {
    const bar = document.getElementById('mixBar');
    if (!bar) return;

    const a=currentWeights.A, b=currentWeights.B, c=currentWeights.C, r=currentWeights.REST;

    const segA = bar.querySelector('.mix-seg.seg-a');
    const segB = bar.querySelector('.mix-seg.seg-b');
    const segC = bar.querySelector('.mix-seg.seg-c');
    const segR = bar.querySelector('.mix-seg.seg-r');

    if (segA) segA.style.width = `${a}%`;
    if (segB) segB.style.width = `${b}%`;
    if (segC) segC.style.width = `${c}%`;
    if (segR) segR.style.width = `${r}%`;

    const handles = [...bar.querySelectorAll('.mix-handle')];
    const cumA=a, cumAB=a+b, cumABC=a+b+c;
    handles.forEach(h=>{
      const key=h.dataset.boundary||'';
      let pct=0;
      if(key==='A|B') pct=cumA;
      if(key==='B|C') pct=cumAB;
      if(key==='C|REST') pct=cumABC;
      h.style.left = `${pct}%`;
    });

    const s = document.getElementById('mixSummary');
    if (s) s.textContent = `A ${a}% • B ${b}% • C ${c}% • Rest ${r}%`;

    const inA=document.getElementById('mixA');
    const inB=document.getElementById('mixB');
    const inC=document.getElementById('mixC');
    const inR=document.getElementById('mixR');
    if(inA) inA.value=a;
    if(inB) inB.value=b;
    if(inC) inC.value=c;
    if(inR) inR.value=r;
  }

  function scheduleSave() {
    if (!currentStyleId) return;
    if (mixSaveT) clearTimeout(mixSaveT);
    mixSaveT = setTimeout(async () => {
      try {
        const { error } = await upsertWeights(currentStyleId, currentWeights);
        if (error) throw error;
      } catch (e) {
        console.error('Failed to save class weights:', e);
      }
    }, 400);
  }

  function setPair(boundary, newLeftVal) {
    const [left, right] = boundary.split('|');
    const sum = (currentWeights[left] ?? 0) + (currentWeights[right] ?? 0);
    const clampedLeft = clamp(newLeftVal, 0, sum);
    currentWeights[left] = clampedLeft;
    currentWeights[right] = sum - clampedLeft;
    currentWeights = normalizeWeights(currentWeights);
    renderMix();
    scheduleSave();
  }

  function setSingle(code, val) {
    const v = clamp(val, 0, 100);
    const other = ['A','B','C','REST'].filter(c=>c!==code);
    let remaining = 100 - v;

    const curSum = other.reduce((s,c)=>s + (currentWeights[c] ?? 0), 0);
    const next = { ...currentWeights, [code]: v };
    if (curSum <= 0) {
      const each = Math.floor(remaining / other.length);
      other.forEach(c => next[c] = each);
      next[other[other.length-1]] += remaining - each*other.length;
    } else {
      other.forEach(c => next[c] = Math.round(((currentWeights[c] ?? 0) / curSum) * remaining));
    }

    currentWeights = normalizeWeights(next);
    renderMix();
    scheduleSave();
  }

  async function loadWeights(styleId) {
    if (!styleId) return;
    try {
      currentWeights = await fetchWeights(styleId);
    } catch (e) {
      console.error('Failed to load class weights:', e);
      currentWeights = { ...DEFAULT_WEIGHTS };
    }
    renderMix();
  }

  function wireMixUI() {
    const inA=document.getElementById('mixA');
    const inB=document.getElementById('mixB');
    const inC=document.getElementById('mixC');
    const inR=document.getElementById('mixR');
    if(inA){ inA.addEventListener('change',()=>setSingle('A',Number(inA.value))); inA.addEventListener('blur',()=>setSingle('A',Number(inA.value))); }
    if(inB){ inB.addEventListener('change',()=>setSingle('B',Number(inB.value))); inB.addEventListener('blur',()=>setSingle('B',Number(inB.value))); }
    if(inC){ inC.addEventListener('change',()=>setSingle('C',Number(inC.value))); inC.addEventListener('blur',()=>setSingle('C',Number(inC.value))); }
    if(inR){ inR.addEventListener('change',()=>setSingle('REST',Number(inR.value))); inR.addEventListener('blur',()=>setSingle('REST',Number(inR.value))); }

    const resetBtn = document.getElementById('resetMixBtn');
    if(resetBtn){
      resetBtn.addEventListener('click', (e)=>{ e.preventDefault(); currentWeights={...DEFAULT_WEIGHTS}; renderMix(); scheduleSave(); });
    }

    const bar=document.getElementById('mixBar');
    if(bar){
      [...bar.querySelectorAll('.mix-handle')].forEach(handle=>{
        handle.addEventListener('pointerdown',(ev)=>{
          if(!currentStyleId) return;
          ev.preventDefault();
          handle.setPointerCapture(ev.pointerId);

          const boundary = handle.dataset.boundary;
          const [left,right]=boundary.split('|');

          const rect = bar.getBoundingClientRect();
          const startX=ev.clientX;
          const startLeft=currentWeights[left]??0;
          const startRight=currentWeights[right]??0;
          const pairSum=startLeft+startRight;

          const onMove=(mv)=>{
            const dx=mv.clientX-startX;
            const pctDelta=Math.round((dx/rect.width)*100);
            const nextLeft=clamp(startLeft+pctDelta,0,pairSum);
            setPair(boundary,nextLeft);
          };
          const onUp=()=>{
            window.removeEventListener('pointermove',onMove);
            window.removeEventListener('pointerup',onUp);
          };
          window.addEventListener('pointermove',onMove);
          window.addEventListener('pointerup',onUp);
        });
      });
    }
  }

  // wire once on load
  wireMixUI();


  // =========================
  // CLASS UI CONFIG
  // =========================
  const CLASS_CONFIG = {
    A: { color: 'var(--power)', label: 'A', description: 'High-priority tracks' },
    B: { color: 'var(--core)', label: 'B', description: 'Core rotation tracks' },
    C: { color: 'var(--library)', label: 'C', description: 'Library tracks' },
    Rest: { color: 'var(--rest)', label: 'Rest', description: 'Rest period tracks' }
  };

  const config = CLASS_CONFIG[currentClassCode] || CLASS_CONFIG.A;
  document.getElementById('classDot').style.background = config.color;
  document.getElementById('classTitle').textContent = config.label;
  document.getElementById('classDescription').textContent = config.description;
  document.getElementById('statLabel').textContent = `In ${config.label}`;

  // =========================
  // STATE + DOM
  // =========================
  let currentStyleId = null;
  let currentStyleName = '';
  let allTracks = [];
  let classCounts = { A: 0, B: 0, C: 0, Rest: 0, Uncategorized: 0 };

  const tbody = document.getElementById('trackBody');
  const selectAll = document.getElementById('selectAll');
  const selBar = document.getElementById('selBar');
  const selN = document.getElementById('selN');
  const selClear = document.getElementById('selClear');
  const statInClass = document.getElementById('statInClass');
  const statPct = document.getElementById('statPct');
  const statTotal = document.getElementById('statTotal');
  const statUnassigned = document.getElementById('statUnassigned');
  const statSel = document.getElementById('statSelected');
  const styleNameEl = document.getElementById('styleName');
  const assignHint = document.getElementById('assignHint');
  const moveBtns = document.querySelectorAll('.assign-btn');
  const styleList = document.getElementById('styleList');
  const trackSearch = document.getElementById('trackSearch');
  const sortBy = document.getElementById('sortBy');
  const styleSearch = document.getElementById('styleSearch');

  document.getElementById('backToManagerBtn')?.addEventListener('click', () => {
  const base = '/index.html'; // change if your manager file name differs
  const url = currentStyleId
    ? `${base}?style_id=${encodeURIComponent(currentStyleId)}`
    : base;

  window.location.href = url;
});

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'success-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  }

  // =========================
  // LOAD + RENDER STYLES
  // =========================
  async function loadStyleStats(styleId) {
    try {
      const rows = await fetchStyleSongRows(styleId);
      const totalTracks = rows.length;

      const assignmentMap = await fetchAssignments(styleId);
      const assignedCount = Object.keys(assignmentMap).length;
      const pct = totalTracks > 0 ? Math.round((assignedCount / totalTracks) * 100) : 0;

      const countEl = document.getElementById(`style-track-count-${styleId}`);
      const badgeEl = document.getElementById(`style-badge-${styleId}`);

      if (countEl) countEl.textContent = `${totalTracks} tracks`;
      if (badgeEl) {
        badgeEl.textContent = `${pct}% assigned`;
        badgeEl.className = 'badge ' + (pct === 100 ? 'b-ok' : pct >= 50 ? 'b-warn' : 'b-bad');
      }
    } catch (err) {
      console.error('Error loading style stats:', err);
    }
  }

  function renderStyleList(styles) {
    styleList.innerHTML = styles.map(style => `
      <div class="style-item" data-style-id="${style.id}" data-style-name="${style.name}">
        <div class="style-name">${style.name}</div>
        <div class="style-meta">
          <span id="style-track-count-${style.id}">— tracks</span>
          <span class="badge b-warn" id="style-badge-${style.id}">—</span>
        </div>
      </div>
    `).join('');

    document.querySelectorAll('.style-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.style-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        loadTracksForStyle(item.dataset.styleId, item.dataset.styleName);
      });
    });
  }

 async function loadStyles() {
  try {
    const { data: styles, error } = await window.db
      .from('sim_styles')
      .select('id, name')
      .order('name');

    if (error) throw error;

    const list = (styles || []).filter(style => style.name !== 'AA Remix');
    renderStyleList(list);

    // ✅ Auto-select immediately (before slow stats)
    if (initialStyleId) {
      const el = document.querySelector(`.style-item[data-style-id="${initialStyleId}"]`);
      if (el) el.click();
    }

    // ✅ Load stats without blocking selection
    list.forEach(style => {
      loadStyleStats(style.id).catch(err => console.error('loadStyleStats failed', err));
    });

  } catch (err) {
    console.error('Error loading styles:', err);
    styleList.innerHTML = `<div class="error">Error loading styles: ${err.message}</div>`;
  }
}


  // =========================
  // LOAD TRACKS
  // =========================
  async function loadTracksForStyle(styleId, styleNameText) {
    currentStyleId = styleId;
    currentStyleName = styleNameText || '';
    styleNameEl.textContent = styleNameText || 'Selected style';
    tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading tracks...</td></tr>';

    try {
      const rows = await fetchStyleSongRows(styleId);
      const assignmentMap = await fetchAssignments(styleId);

      // Cap at 3000 tracks
      const limitedRows = rows.slice(0, 3000);
      const showingCapped = rows.length > 3000;

      allTracks = limitedRows
        .filter(r => r.song_id && r.song)
        .map(r => {
          const s = r.song;
          return {
            id: r.song_id,
            title: s.title || 'Unknown Title',
            artist: s.artist || 'Unknown Artist',
            album: s.album || '',
            year: s.year || '',
            duration: s.duration || 0,
            class_code: assignmentMap[r.song_id] || null
          };
        });

      // Show warning if tracks were capped
      if (showingCapped) {
        const infoDiv = document.querySelector('.info');
        if (infoDiv) {
          infoDiv.innerHTML = `⚠️ This style has ${rows.length.toLocaleString()} tracks. Showing first 3,000 for performance. 
          These tracks are currently in this class. Select tracks and use the sidebar to move them to another class or back to Uncategorized.`;
          infoDiv.style.background = '#fff3cd';
          infoDiv.style.borderLeftColor = '#f39c12';
        }
      } else {
        const infoDiv = document.querySelector('.info');
        if (infoDiv) {
          infoDiv.innerHTML = `These tracks are currently in this class. Select tracks and use the sidebar to move them to another class or back to Uncategorized.`;
          infoDiv.style.background = '#e8f4f8';
          infoDiv.style.borderLeftColor = '#3498db';
        }
      }

      updateStats();
      renderTable();
    } catch (err) {
      console.error('Error loading tracks:', err);
      tbody.innerHTML = `<tr><td colspan="7" class="error">Error loading tracks: ${err.message}</td></tr>`;
    }
  }

  function updateStats() {
    const totalCount = allTracks.length;
    const inClassCount = allTracks.filter(t => t.class_code === currentClassCode).length;
    const unassignedCount = allTracks.filter(t => !t.class_code).length;
    const pct = totalCount > 0 ? ((inClassCount / totalCount) * 100).toFixed(1) : '0.0';

    document.getElementById('statTotal').textContent = totalCount;
    document.getElementById('statInClass').textContent = inClassCount;
    document.getElementById('statPct').textContent = pct + '%';
    document.getElementById('statUnassigned').textContent = unassignedCount;

    classCounts = { A: 0, B: 0, C: 0, Rest: 0, Uncategorized: 0 };
    allTracks.forEach(t => {
      if (t.class_code) classCounts[t.class_code] = (classCounts[t.class_code] || 0) + 1;
      else classCounts.Uncategorized++;
    });

    moveBtns.forEach(btn => {
      const cls = btn.dataset.class;
      btn.querySelector('.ab-count').textContent = classCounts[cls] || 0;
      if (cls === currentClassCode) btn.disabled = true;
    });
  }

  function renderTable() {
    let visible = allTracks.filter(t => t.class_code === currentClassCode);

    const q = trackSearch.value.trim().toLowerCase();
    if (q) {
      visible = visible.filter(t =>
        (t.title || '').toLowerCase().includes(q) ||
        (t.artist || '').toLowerCase().includes(q) ||
        (t.album || '').toLowerCase().includes(q)
      );
    }

    const sortField = sortBy.value;
    visible.sort((a, b) => ((a[sortField]||'')+'').localeCompare((b[sortField]||'')+''));

    if (visible.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="loading">No tracks in this class</td></tr>';
      selectAll.checked = false;
      updateUI();
      return;
    }

    tbody.innerHTML = visible.map(t => {
      const mins = Math.floor((t.duration || 0) / 60);
      const styleTokens = (t.styles || '')
  .split('|')
  .map(s => s.trim())
  .filter(Boolean);

const visibleStyles = styleTokens.slice(0, 2).join(' | ');
const hasMore = styleTokens.length > 2;

      const secs = ((t.duration || 0) % 60).toString().padStart(2, '0');
      const timeStr = `${mins}:${secs}`;
      return `
        <tr data-track-id="${t.id}">
          <td><input type="checkbox" class="rowCheck" /></td>
          <td><img class="art" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%233498db' width='40' height='40'/%3E%3C/svg%3E" /></td>
          <td><strong>${t.title}</strong></td>
          <td>${t.artist}</td>
          <td>${t.album}</td>
          <td
            title="${styleTokens.join(' | ').replace(/"/g,'&quot;')}"
            style="max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#7f8c8d;"
            >
  ${visibleStyles}${hasMore ? ' …' : ''}
          </td>
          <td>${t.year}</td>
          <td class="num">${timeStr}</td>
        </tr>
      `;
    }).join('');

    tbody.querySelectorAll('.rowCheck').forEach(cb => {
      cb.addEventListener('change', () => {
        cb.closest('tr').classList.toggle('checked', cb.checked);
        syncSelectAll();
        updateUI();
      });
    });

    updateUI();
  }

  function syncSelectAll() {
    const checks = [...tbody.querySelectorAll('.rowCheck')];
    selectAll.checked = checks.length > 0 && checks.every(c => c.checked);
  }

  function updateUI() {
    const sel = [...tbody.querySelectorAll('.rowCheck:checked')].length;
    statSel.textContent = sel;
    selBar.classList.toggle('visible', sel > 0);
    selN.textContent = sel;
    moveBtns.forEach(b => {
      if (b.dataset.class === currentClassCode) return;
      b.disabled = sel === 0;
    });
    assignHint.style.display = sel ? 'none' : 'block';
  }

  selectAll.addEventListener('change', () => {
    tbody.querySelectorAll('.rowCheck').forEach(cb => {
      cb.checked = selectAll.checked;
      cb.closest('tr').classList.toggle('checked', cb.checked);
    });
    updateUI();
  });

  selClear.addEventListener('click', () => {
    tbody.querySelectorAll('.rowCheck').forEach(cb => {
      cb.checked = false;
      cb.closest('tr').classList.remove('checked');
    });
    selectAll.checked = false;
    updateUI();
  });

  // MOVE
  moveBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!currentStyleId) return;

      const targetClass = btn.dataset.class;
      const checked = [...tbody.querySelectorAll('tr.checked')];
      const songIds = checked.map(tr => tr.dataset.trackId);
      if (songIds.length === 0) return;

      try {
        if (targetClass === 'Uncategorized') {
          const { error } = await deleteAssignments(currentStyleId, songIds);
          if (error) throw error;
          songIds.forEach(id => { const t = allTracks.find(x => x.id === id); if (t) t.class_code = null; });
          showToast(`Moved ${songIds.length} to Uncategorized`);
        } else {
          const { error } = await upsertAssignments(songIds.map(id => ({ song_id: id, style_id: currentStyleId, class_code: targetClass })));
          if (error) throw error;
          songIds.forEach(id => { const t = allTracks.find(x => x.id === id); if (t) t.class_code = targetClass; });
          showToast(`Moved ${songIds.length} to ${targetClass}`);
        }

        updateStats();
        renderTable();
        selectAll.checked = false;

        await loadStyleStats(currentStyleId);
      } catch (err) {
        console.error('Error moving tracks:', err);
        alert('Error moving tracks: ' + err.message);
      }
    });
  });

  trackSearch.addEventListener('input', renderTable);
  sortBy.addEventListener('change', renderTable);

  // style search filter (client-side)
  styleSearch.addEventListener('input', () => {
    const q = styleSearch.value.trim().toLowerCase();
    document.querySelectorAll('.style-item').forEach(el => {
      const name = (el.dataset.styleName || '').toLowerCase();
      el.style.display = !q || name.includes(q) ? '' : 'none';
    });
  });

  // INIT
  loadStyles();
</script>
</body>
</html>
